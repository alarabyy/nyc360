<div class="page-container page-fade-in">
  
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner-border text-accent" role="status"></div>
    <p>Loading Profile...</p>
  </div>

  <div *ngIf="!isLoading && errorMessage" class="error-container">
    <i class="bi bi-exclamation-octagon"></i>
    <p>{{ errorMessage }}</p>
  </div>

  <div *ngIf="!isLoading && userProfile" class="profile-layout">
    
    <div class="profile-sidebar">
      <div class="sidebar-card">
        
        <div class="avatar-wrapper">
          <img [src]="imagePreview || (userProfile.imageUrl ? environment.apiBaseUrl2 + '/avatars/' + userProfile.imageUrl : '')" 
               class="avatar-img" 
               *ngIf="userProfile.imageUrl || imagePreview">
          
          <div *ngIf="!userProfile.imageUrl && !imagePreview" class="avatar-placeholder">
            {{ getInitials() }}
          </div>

          <label *ngIf="isEditMode && isOwner" class="edit-btn">
            <i class="bi bi-camera-fill"></i>
            <input type="file" (change)="onFileSelected($event)" accept="image/*" hidden>
          </label>

          <div class="verified-badge" *ngIf="isVerifiedUser">
            <i class="bi bi-patch-check-fill"></i>
          </div>
        </div>

        <div class="user-identity">
          <h2 class="user-name">
            {{ getDisplayName() }}
            <i class="bi bi-patch-check-fill text-accent" *ngIf="isVerifiedUser" title="Verified"></i>
          </h2>
          <p class="user-label">{{ getUserLabel() }}</p>
        </div>

        <div class="divider"></div>

        <div class="stats-grid" *ngIf="stats">
          <div class="stat-box">
            <span class="val">{{ stats.postsCount || 0 }}</span>
            <span class="lbl">Posts</span>
          </div>
          <div class="stat-box">
            <span class="val">{{ stats.followersCount || 0 }}</span>
            <span class="lbl">Followers</span>
          </div>
          <div class="stat-box">
            <span class="val">{{ stats.likesCount || 0 }}</span>
            <span class="lbl">Likes</span>
          </div>
        </div>

        <div class="security-box" *ngIf="isOwner">
          <div class="sec-row">
            <span>2FA Security</span>
            <span class="badge" [class.enabled]="userProfile.twoFactorEnabled">
              {{ userProfile.twoFactorEnabled ? 'ON' : 'OFF' }}
            </span>
          </div>
          <button class="btn-toggle" (click)="toggle2FA()">
            {{ userProfile.twoFactorEnabled ? 'Disable' : 'Enable' }}
          </button>
        </div>

      </div>
    </div>

    <div class="profile-main">
      <div class="main-card">
        
        <div class="card-header">
          <h3>Details</h3>
          <button class="btn-icon-text" (click)="toggleEditMode()" *ngIf="isOwner && !isEditMode">
            <i class="bi bi-pencil"></i> Edit
          </button>
        </div>

        <form [formGroup]="profileForm" (ngSubmit)="saveChanges()">
          
          <div *ngIf="isOrg" class="form-grid">
            <div class="form-group full-width">
              <label>Organization Name</label>
              <div class="input-wrap">
                <i class="bi bi-building"></i>
                <input [readonly]="!isEditMode || !isOwner" formControlName="name" type="text">
              </div>
            </div>
          </div>

          <div *ngIf="isNormal || isAdmin" class="form-grid two-cols">
            <div class="form-group">
              <label>First Name</label>
              <div class="input-wrap">
                <i class="bi bi-person"></i>
                <input [readonly]="!isEditMode || !isOwner" formControlName="firstName" type="text">
              </div>
            </div>
            <div class="form-group">
              <label>Last Name</label>
              <div class="input-wrap">
                <i class="bi bi-person"></i>
                <input [readonly]="!isEditMode || !isOwner" formControlName="lastName" type="text">
              </div>
            </div>
          </div>

          <div class="form-group full-width" *ngIf="isOrg || isNormal">
            <label>Bio</label>
            <div class="input-wrap">
              <textarea [readonly]="!isEditMode || !isOwner" formControlName="bio" placeholder="No bio available..."></textarea>
            </div>
          </div>

          <div class="form-group full-width">
            <label>Email Address</label>
            <div class="input-wrap">
              <i class="bi bi-envelope"></i>
              <input readonly [value]="userProfile.email" type="text" class="readonly-text">
            </div>
          </div>

          <div *ngIf="isOrg || isNormal" class="social-section">
            <h4>Social Presence</h4>
            <div class="form-grid two-cols">
              
              <div class="form-group">
                <label>Website</label>
                <div class="input-wrap"><i class="bi bi-globe"></i>
                  <input [readonly]="!isEditMode || !isOwner" formControlName="websiteUrl" type="url">
                </div>
              </div>
              <div class="form-group">
                <label>Facebook</label>
                <div class="input-wrap"><i class="bi bi-facebook"></i>
                  <input [readonly]="!isEditMode || !isOwner" formControlName="facebookUrl" type="text">
                </div>
              </div>
              <div class="form-group">
                <label>Twitter / X</label>
                <div class="input-wrap"><i class="bi bi-twitter-x"></i>
                  <input [readonly]="!isEditMode || !isOwner" formControlName="twitterUrl" type="text">
                </div>
              </div>
              <div class="form-group">
                <label>Instagram</label>
                <div class="input-wrap"><i class="bi bi-instagram"></i>
                  <input [readonly]="!isEditMode || !isOwner" formControlName="instagramUrl" type="text">
                </div>
              </div>
              <div class="form-group">
                <label>LinkedIn</label>
                <div class="input-wrap"><i class="bi bi-linkedin"></i>
                  <input [readonly]="!isEditMode || !isOwner" formControlName="linkedinUrl" type="text">
                </div>
              </div>
              <div class="form-group">
                <label>GitHub</label>
                <div class="input-wrap"><i class="bi bi-github"></i>
                  <input [readonly]="!isEditMode || !isOwner" formControlName="githubUrl" type="text">
                </div>
              </div>

            </div>
          </div>

          <div class="form-actions" *ngIf="isOwner && isEditMode">
            <button type="button" class="btn-cancel" (click)="toggleEditMode()">Cancel</button>
            <button type="submit" class="btn-save" [disabled]="isSaving">
              {{ isSaving ? 'Saving...' : 'Save Changes' }}
            </button>
          </div>

        </form>
      </div>
    </div>

  </div>
</div>